# - name: Install Python
#   become: true
#   become_method: sudo
#   become_user: root
#   raw: apt -y update && apt install -y python3
#   # changed_when: false

# # - name: "install python for Ansible."
# #   become: true
# #   raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3)
# #   changed_when: false

# - name: Install nodejs
#   become: true
#   become_method: sudo
#   become_user: root
#   raw: apt -y update && apt -y install  nodejs 
#   # changed_when: false

# - name: Install npm
#   become: true
#   become_method: sudo
#   become_user: root
#   raw: apt -y update && apt install -y   npm
#   # changed_when: false
  
- name: install nvm 
  shell: |
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
- name: install node 13.8 
  shell: |
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
      [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
      nvm install 13.8


- name: install global packages
  apt: pkg={{ item }} update_cache=yes cache_valid_time=3600
  become: True
  become_method: sudo
  with_items:
    - python3
    - npm



- name: Extract artifact
  ansible.builtin.shell: tar -xvf /home/ubuntu/artifact.tar.gz 



- name: Extract artifact
  ansible.builtin.shell: tar -xvf /home/ubuntu/artifact.tar.gz 
- name: start the app
  become: true
  become_method: sudo
  # become_user: root
  ansible.builtin.shell: |
    npm install
    sudo npm i -g pm2
    pm2 stop default
    pm2 start npm -- start 
    # nohup  pm2 start npm -- start &
    pm2 start npm -- start  </dev/null >/dev/null 2>&1 &

